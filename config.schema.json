{
  "pluginAlias": "ProtectWebhookPlatform",
  "pluginType": "platform",
  "customUi": true,
  "singular": true,
  "schema": {
    "type": "object",
    "properties": {
      "name": {
        "type": "string",
        "title": "Name",
        "default": "UniFi Protect Webhook",
        "description": "Nome visualizzato nella UI. Lascia il default se non sai cosa mettere."
      },
      "adminSecret": {
        "type": "string",
        "title": "Admin Secret (opzionale)",
        "description": "Segreto per endpoint amministrativi (reveal/regenerate token e info URL). Non viene mostrato nei log. Consigliato impostarlo. La gestione operativa avviene dalla UI Admin integrata nella pagina del plugin."
      },
      "bindAddress": {
        "type": "string",
        "title": "Bind address",
        "description": "Indirizzo su cui il server HTTP ascolta (default 0.0.0.0). L'accesso è comunque limitato alla rete locale se enforceLocalOnly=true",
        "default": "0.0.0.0"
      },
      "port": {
        "type": "number",
        "title": "Port",
        "default": 12050,
        "description": "Porta HTTP del server webhook. Cambiala solo se confligge con altri servizi."
      },
      "enforceLocalOnly": {
        "type": "boolean",
        "title": "Enforce local-only",
        "description": "Se true (default) blocca richieste da IP non privati RFC1918/loopback",
        "default": true
      },
         "publicHost": {
           "type": "string",
           "title": "Host/IP pubblico per URL webhook",
           "description": "Hostname o IP della macchina Homebridge da usare quando si generano/rivelano gli URL dei webhook. Se omesso viene rilevato automaticamente il primo IP privato disponibile. Imposta manualmente se nell'UI vedi 127.0.0.1 ma UniFi Protect è su un altro host. Esempio: 192.168.1.50"
         },
      "webhooks": {
        "type": "array",
        "description": "Definizione manuale avanzata. Per creare velocemente un webhook usa il form nella UI Admin in basso (inserisci solo Nome, path e token auto).",
        "items": {
          "type": "object",
          "properties": {
            "name": { "type": "string", "title": "Name" },
            "path": { "type": "string", "title": "Path (obbligatorio)", "description": "Deve iniziare con /wh/ (es. /wh/porta-ingresso)", "pattern": "^/wh/.*" },
            "token": { "type": "string", "title": "Token (optional, auto-generated if empty)", "description": "Se vuoto viene generato automaticamente e NON viene scritto nei log. Puoi recuperarlo in modo sicuro via endpoint admin /admin/webhooks/<name>/token." },
            "debounceSeconds": { "type": "number", "title": "Debounce (s)", "default": 0 },
            "durationSeconds": { "type": "number", "title": "Duration ON (s)", "default": 10 },
            "allowedIps": { "type": "string", "title": "Allowed IPs (comma-separated)" }
          },
          "required": ["name", "path"]
        }
      },
      "emailTriggers": {
        "type": "array",
        "description": "Configurali qui solo se necessario. Il pannello Admin mostra un riepilogo e consente l'uso operazionale in sicurezza.",
        "items": {
          "type": "object",
          "properties": {
            "name": { "type": "string", "title": "Name" },
            "imapHost": { "type": "string", "title": "IMAP Host (gmail: imap.gmail.com)" },
            "imapPort": { "type": "number", "title": "IMAP Port", "default": 993 },
            "imapTls": { "type": "boolean", "title": "Use TLS", "default": true },
            "imapUser": { "type": "string", "title": "IMAP Username / Email" },
            "imapPassword": { "type": "string", "title": "IMAP Password / App Password" },
            "subjectMatch": { "type": "string", "title": "Subject regex or substring to match" },
            "debounceSeconds": { "type": "number", "title": "Debounce (s)", "default": 0 },
            "durationSeconds": { "type": "number", "title": "Duration ON (s)", "default": 10 }
          },
          "required": ["name", "imapHost", "imapUser", "imapPassword", "subjectMatch"]
        }
      }
    },
    "required": []
  },
  "layout": [
    {
      "type": "header",
      "title": "UI Amministrativa Integrata",
      "description": "Per creare rapidamente un Webhook inserisci solo il Nome nel form in basso. L'URL completo viene mostrato una sola volta (Rivela URL). Per un nuovo URL usa Rigenera."
    },
    {
      "type": "header",
      "title": "Suggerimento: esegui come Child Bridge",
      "description": "Per avere il pulsante 'Plugin Logs' e isolare i log/processo, abilita 'Run as Child Bridge' dalle impostazioni del plugin in Homebridge UI e riavvia. Questa opzione si imposta dalla UI, non dal JSON di configurazione del plugin."
    },
    {
      "type": "section",
      "title": "Generale",
      "items": [
        "name",
        "adminSecret",
        "bindAddress",
        "port",
        "enforceLocalOnly"
      ]
    },
    {
      "type": "section",
      "title": "Webhooks (configurazione manuale)",
      "expandable": true,
      "expanded": false,
      "items": ["webhooks"]
        "publicBaseUrl": {
          "type": "string",
          "title": "Base URL pubblico completo",
          "description": "URL completo (es: https://homebridge.miodominio.it:8443/hb) da usare per generare gli URL dei webhook. Ha priorità su publicHost e permette HTTPS, porta diversa o path base dietro reverse proxy.",
          "default": ""
        },
        "trustProxyHeaders": {
          "type": "boolean",
          "title": "Usa intestazioni X-Forwarded-*",
          "description": "Se true e il plugin è dietro un reverse proxy che imposta X-Forwarded-Host / X-Forwarded-Proto, queste verranno usate per costruire la base URL.",
          "default": false
        },
    },
    {
      "type": "section",
      "title": "Email triggers (configurazione manuale)",
      "expandable": true,
      "expanded": false,
      "items": ["emailTriggers"]
    }
  ]
}
