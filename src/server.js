"use strict";

const express = require("express");
const bodyParser = require("body-parser");
const { v4: uuidv4 } = require("uuid");

module.exports = function createServer(platform) {
	const app = express();
	app.disable("x-powered-by");
	app.use(bodyParser.json({ limit: "256kb" }));
	app.use(bodyParser.urlencoded({ extended: false }));

	// Basic request logger at debug level (with redaction)
	app.use((req, res, next) => {
		const redactedUrl = platform._redactUrl(req.url);
		platform.log.debug(`HTTP ${req.method} ${redactedUrl} from ${platform._getRemoteIp(req)}`);
		next();
	});

	// Security middleware: enforce local LAN only if enabled
	app.use((req, res, next) => {
		if (!platform.enforceLocalOnly) return next();
		const ip = platform._getRemoteIp(req);
		if (platform._isPrivateIp(ip)) return next();
		platform.log.warn(`Blocked non-local request from ${ip}`);
		return res.status(403).json({ error: "forbidden" });
	});

	// Admin endpoints (local only + adminSecret if set)
	// Reveal token (only once if autogenerated)
	app.get("/admin/webhooks/:name/token", (req, res) => {
		if (!platform._isLocalAdminRequest(req)) return res.status(403).json({ error: "forbidden" });
		const name = req.params.name;
		const wh = platform.webhooks.find(w => w.name === name);
		if (!wh) return res.status(404).json({ error: "not found" });
		// Reveal only once if autogenerated and not revealed yet
		const key = `webhook:${wh.name}`;
		const accessory = platform.accessories.get(key);
		const revealed = accessory?.context?.tokenRevealed === true;
		const autogenerated = accessory?.context?.tokenAutogenerated === true || !!wh._autogenerated;
		if (!wh.token) return res.status(400).json({ error: "no token" });
		if (!autogenerated) {
			return res.status(400).json({ error: "token not autogenerated; manage it in config" });
		}
		if (revealed) {
			return res.status(410).json({ error: "token already revealed" });
		}
		if (accessory) {
			accessory.context.tokenRevealed = true;
			platform.api.updatePlatformAccessories([accessory]);
		}
		const url = platform._composeWebhookUrl(req, wh);
		return res.json({ name, token: wh.token, url, autogenerated: true, firstReveal: true });
	});

	// Regenerate token and return first-reveal info
	app.post("/admin/webhooks/:name/regenerate", (req, res) => {
		if (!platform._isLocalAdminRequest(req)) return res.status(403).json({ error: "forbidden" });
		const name = req.params.name;
		const wh = platform.webhooks.find(w => w.name === name);
		if (!wh) return res.status(404).json({ error: "not found" });
		wh.token = uuidv4();
		wh._autogenerated = true; // mark as autogenerated
		const key = `webhook:${wh.name}`;
		const accessory = platform.accessories.get(key);
		if (accessory) {
			accessory.context.token = wh.token;
			accessory.context.tokenAutogenerated = true;
			accessory.context.tokenRevealed = false;
			platform.api.updatePlatformAccessories([accessory]);
		}
		const url = platform._composeWebhookUrl(req, wh);
		return res.json({ name, token: wh.token, url, regenerated: true, firstReveal: true });
	});

	// List webhooks (names and paths only, no tokens)
	app.get("/admin/webhooks", (req, res) => {
		if (!platform._isLocalAdminRequest(req)) return res.status(403).json({ error: "forbidden" });
		const list = platform.webhooks.map((w) => ({ name: w.name, path: platform._computeWebhookPath(w) }));
		return res.json({ webhooks: list });
	});

	// Get webhook info and a safe URL (token redacted unless first reveal)
	app.get("/admin/webhooks/:name/info", (req, res) => {
		if (!platform._isLocalAdminRequest(req)) return res.status(403).json({ error: "forbidden" });
		const name = req.params.name;
		const wh = platform.webhooks.find(w => w.name === name);
		if (!wh) return res.status(404).json({ error: "not found" });
		const key = `webhook:${wh.name}`;
		const accessory = platform.accessories.get(key);
		const autogenerated = accessory?.context?.tokenAutogenerated === true || !!wh._autogenerated;
		const revealed = accessory?.context?.tokenRevealed === true;
		const path = platform._computeWebhookPath(wh);
		const base = platform._serverBaseUrl(req);
		let url = `${base}${path}`;
		if (wh.token) {
			if (autogenerated && !revealed) {
				url = `${url}?token=REDACTED`;
			} else {
				url = `${url}?token=${encodeURIComponent(wh.token)}`;
			}
		}
		return res.json({ name, path, url, tokenAutogenerated: !!autogenerated, tokenFirstRevealed: !!revealed });
	});

	const server = app.listen(platform.port, platform.bindAddress, () => {
		platform.log.info(`Webhook server listening on ${platform._serverBaseUrl()} (local-only=${platform.enforceLocalOnly})`);
	});

	// graceful shutdown
	const shutdown = () => {
		try { server && server.close(); } catch (_) {}
	};
	process.on("SIGINT", shutdown);
	process.on("SIGTERM", shutdown);

	return { app, server };
}
