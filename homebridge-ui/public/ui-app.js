function escapeHtml(s) { return String(s).replace(/[&<>"']/g, c => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
function escapeAttr(s) { return escapeHtml(s).replace(/"/g, '&quot;'); }

let pluginConfig = {};

async function request(path, body) {
  const payload = { ...(body || {}) };
  payload.config = pluginConfig || {};
  return await window.homebridge.request(path, payload);
}

async function loadPluginConfig() {
  try {
    const cfgArr = await window.homebridge.getPluginConfig();
    pluginConfig = (Array.isArray(cfgArr) && cfgArr[0]) ? cfgArr[0] : {};
  } catch (e) {
    console.error('Impossibile recuperare la configurazione del plugin:', e);
    pluginConfig = {};
  }
}

async function loadState() {
  try {
    const data = await request('/state');
    if (data && data.notReady) {
      setDiagMsg('Server non ancora pronto, ritento...');
      setTimeout(loadState, 800);
      return;
    }
    renderWebhooks(data.webhooks || []);
    renderEmails(data.emailTriggers || []);
    setDiagMsg('Stato aggiornato');
  } catch (e) {
    window.homebridge.toast.error('Errore nel caricamento stato: ' + (e?.message || e));
    setDiagMsg('Errore stato');
  }
}

function renderWebhooks(items) {
  const tbody = document.querySelector('#webhooksTable tbody');
  tbody.innerHTML = '';
  for (const w of items) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(w.name)}</td>
      <td><code>${escapeHtml(w.path)}</code></td>
      <td><code>${escapeHtml(w.url)}</code></td>
      <td>${w.permanentToken ? `<code>${escapeHtml(w.permanentToken)}</code>` : '<em>nascosto</em>'}</td>
      <td>
        <button class="action secondary" data-action="info" data-name="${escapeAttr(w.name)}">Info</button>
        <button class="action" data-action="ephemeral" data-name="${escapeAttr(w.name)}">Genera URL temporaneo</button>
        <button class="action warn" data-action="regenerate" data-name="${escapeAttr(w.name)}">Rigenera token</button>
      </td>
    `;
    tbody.appendChild(tr);
  }
}

function renderEmails(items) {
  const tbody = document.querySelector('#emailTable tbody');
  tbody.innerHTML = '';
  for (const e of items) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(e.name)}</td>
      <td>${escapeHtml(e.imapHost || '')}</td>
      <td>${e.debounceSeconds ?? 0}</td>
      <td>${e.durationSeconds ?? 10}</td>
    `;
    tbody.appendChild(tr);
  }
}

function showOutput(text) {
  const sec = document.querySelector('#ephemeralOutput');
  const div = document.querySelector('#ephemeralContent');
  div.textContent = text;
  sec.classList.remove('hidden');
}

async function onTableClick(ev) {
  const btn = ev.target.closest('button[data-action]');
  if (!btn) return;
  const name = btn.getAttribute('data-name');
  const action = btn.getAttribute('data-action');
  try {
    if (action === 'info') {
      const data = await request('/info', { name });
      showOutput(`URL: ${escapeHtml(data.url)}\nPath: ${escapeHtml(data.path)}\nAutogenerated: ${data.tokenAutogenerated}`);
    } else if (action === 'ephemeral') {
      const ttl = 300;
      const data = await request('/ephemeral', { name, ttl });
      showOutput(`URL temporaneo (TTL ${data.ttlSeconds}s):\n${escapeHtml(data.url)}`);
    } else if (action === 'regenerate') {
      if (!confirm(`Rigenerare il token permanente per '${name}'?`)) return;
      const data = await request('/regenerate', { name });
      showOutput(`Nuovo token permanente (prima rivelazione):\n${escapeHtml(data.url)}`);
      await loadState();
    }
  } catch (e) {
    window.homebridge.toast.error('Errore: ' + (e?.message || e));
  }
}

function setDiagMsg(msg) {
  const el = document.getElementById('diagMsg');
  if (el) el.textContent = msg;
}

async function ping() {
  const t0 = performance.now();
  try {
    const res = await request('/ping');
    if (res && res.notReady) {
      setDiagMsg('Server non ancora pronto (ping).');
      return;
    }
    const dt = res?.ms ?? Math.round(performance.now() - t0);
    setDiagMsg(`Ping ok (${dt}ms)`);
  } catch (e) {
    setDiagMsg('Ping fallito');
  }
}

window.addEventListener('DOMContentLoaded', async () => {
  document.querySelector('#webhooksTable').addEventListener('click', onTableClick);
  const btnRefresh = document.getElementById('btnRefresh');
  const btnPing = document.getElementById('btnPing');
  btnRefresh && btnRefresh.addEventListener('click', () => loadState());
  btnPing && btnPing.addEventListener('click', () => ping());
  await loadPluginConfig();
  loadState();
});
