# homebridge-unifi-protect-webhook

Homebridge plugin that exposes local HTTP webhook endpoints and IMAP email triggers as HomeKit Motion Sensors for UniFi Protect / Reolink integration.

[Leggi in Italiano](./README.it.md)

## Features

- Multiple named webhook endpoints, each protected by a token.
- Email triggers via IMAP (Gmail supported with App Password) firing when a matching subject arrives.
- Per-trigger options: debounce (cooldown), active duration, IP allowlist, custom path.
- Security: local-network enforcement (RFC1918) enabled by default, per‑webhook tokens, optional admin secret for secure token reveal/regeneration.

## Installation

1. Place/install the plugin under Homebridge and run `npm install` in the plugin directory.
2. Restart Homebridge.
3. Configure via Homebridge UI (Platform: `ProtectWebhookPlatform`).

### Where to find the Admin UI (integrated)

If you only see the configuration schema and not the Admin panel:

1. Ensure you're running Homebridge UI X >= 1.8.0 (or Homebridge 2.0) with Node >= 20.
2. Update the plugin to v0.2.5 or later (metadata includes the proper `engines` for UI injection).
3. Hard‑refresh the browser (Ctrl+F5) or clear cache.
4. If still missing, check Homebridge logs on startup for: `Plugin Ui server started` (should appear automatically). Any error thrown in `homebridge-ui/server.js` will prevent panel rendering.

Once visible, the Admin panel lets you:

- View safe webhook info (token redacted until first reveal if autogenerated).
- Generate temporary URLs with short‑lived tokens.
- Regenerate a permanent token (first reveal only).
- Reveal an autogenerated token exactly once.
- Ping / refresh diagnostics to verify connectivity.

## Security

- Server binds by default to `0.0.0.0` but blocks non-local IPs if `enforceLocalOnly=true`.
- Always use webhook tokens. If empty, one is generated and stored in accessory context (not printed in logs).
- Further restrict with `allowedIps` (comma‑separated list).

### Token reveal, URL info & UI integrata in Homebridge

- Set an `adminSecret` to enable admin endpoints.
- Reveal token once (only if auto-generated and not revealed before):

```powershell
curl "http://<HB-IP>:12050/admin/webhooks/<NAME>/token?adminSecret=<ADMIN_SECRET>"
```

- Get a base webhook URL (token redacted if not yet revealed):

```powershell
curl "http://<HB-IP>:12050/admin/webhooks/<NAME>/info?adminSecret=<ADMIN_SECRET>"
```

- Regenerate a lost token:

```powershell
curl -X POST "http://<HB-IP>:12050/admin/webhooks/<NAME>/regenerate?adminSecret=<ADMIN_SECRET>"
```

Integrated UI (inside Homebridge Config UI):

- Open the plugin page: a top section lists configuration fields and the Admin panel area.
- Click "Genera URL temporaneo" to obtain an ephemeral URL (token a vita breve) without exposing the permanent token.
- Use "Rigenera token" for a lost token (first reveal included in the response).

Note:

- As of v0.2.0, the old external page served at `/admin/ui` has been removed. Use the plugin page inside Homebridge UI instead.
- From v0.2.5 the `engines` field enforces modern versions to flag the plugin as Homebridge 2.0 ready.

Notes:

- Admin endpoints are local‑network only; if `adminSecret` is set, it must be provided (header `x-admin-secret` or query `?adminSecret=`).
- Tokens are never logged and sensitive query params are redacted in logs (`token`/`adminSecret`). Copy from the admin endpoint response and store securely.

## Configuration (Homebridge UI)

- bindAddress: HTTP server bind address (default 0.0.0.0).
- port: server port (default 12050).
- enforceLocalOnly: block non‑RFC1918 IPs if true (default true).
- adminSecret: secret for admin token endpoints (optional but recommended).
- webhooks: array
  - name: sensor/endpoint name.
  - path: HTTP path (must start with `/wh/`), supports GET & POST.
  - token: if empty, auto-generated; supply via header `x-webhook-token` or `?token=`.
  - debounceSeconds: minimum time between activations.
  - durationSeconds: active ON duration before reset.
  - allowedIps: comma separated allowlist.
- emailTriggers: array (IMAP)
  - name: sensor name.
  - imapHost/Port/TLS: IMAP parameters (Gmail: `imap.gmail.com:993/TLS`).
  - imapUser / imapPassword: IMAP credentials (Gmail: App Password).
  - subjectMatch: regex or substring to match email subject.
  - debounceSeconds / durationSeconds: as above.

## Examples

Trigger webhook:

```powershell
curl -X POST "http://<HB-IP>:12050/wh/front-door?token=<TOKEN>"
```

Reolink email filter: set `subjectMatch` to a stable substring (e.g. `Reolink Alert`).

## Gmail Notes

- Enable 2FA + create an IMAP App Password.
- Emails are marked as read after being processed.

## Logging

Uses Homebridge logger (info/debug/warn/error). Enable debug for detailed request tracing.

## Child Bridge (Plugin Logs button)

To get a dedicated "Plugin Logs" button and isolate crashes, run the plugin as a **Child Bridge**:

1. Open Homebridge UI → Plugins → `homebridge-unifi-protect-webhook`.
2. Click the wrench (settings) icon.
3. Enable the toggle **Run as Child Bridge** (wording may be "Enable Child Bridge" depending on UI version).
4. Save and restart Homebridge.

Benefits:

- Separate process: a fault in webhooks or IMAP code won't crash the main bridge.
- Dedicated log stream: you will see the plugin banner and diagnostic lines under the Plugin Logs tab.
- Easier restarts and memory isolation.

Notes:

- No configuration changes required; existing config.json entries are reused.
- Port binding remains the same; ensure the chosen port isn't used by another Child Bridge plugin.
- Disable and re‑enable Child Bridge if the UI doesn't show the logs after the first restart.

Example of expected startup lines after enabling:

```text
═══════════════════════════════════════════════════
  UniFi Protect Webhook Plugin
  Webhook & Email triggers → HomeKit Motion Sensors
═══════════════════════════════════════════════════
```
Followed by diagnostic entries like:

```text
[DIAGNOSTIC] Creating HTTP server...
[DIAGNOSTIC] Server created, setting up webhooks...
```
